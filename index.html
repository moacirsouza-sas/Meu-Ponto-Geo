
<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ponto Inteligente OCR & GPS</title>
    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@4/dist/tesseract.min.js"></script>
    <style>
        :root { --primary: #2563eb; --success: #16a34a; --danger: #dc2626; --bg: #f1f5f9; --text: #1e293b; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); padding: 15px; display: flex; flex-direction: column; align-items: center; }
        .card { background: white; padding: 20px; border-radius: 15px; box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1); width: 100%; max-width: 450px; margin-bottom: 20px; }
        .grid-inputs { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-top: 15px; }
        input { padding: 12px; border: 1px solid #cbd5e1; border-radius: 8px; width: 100%; box-sizing: border-box; text-align: center; font-weight: bold; }
        button { cursor: pointer; padding: 14px; border-radius: 8px; border: none; font-weight: bold; transition: 0.3s; width: 100%; }
        .btn-main { background: var(--primary); color: white; font-size: 1.1rem; display: flex; align-items: center; justify-content: center; gap: 10px; }
        .btn-save { background: var(--text); color: white; margin-top: 15px; }
        .status-box { margin-top: 10px; font-size: 0.85rem; padding: 10px; border-radius: 8px; background: #f8fafc; border: 1px solid #e2e8f0; }
        #preview { max-width: 100%; border-radius: 10px; margin-top: 15px; display: none; border: 1px solid #ddd; }
        .history-grid { width: 100%; max-width: 450px; display: flex; flex-direction: column; gap: 10px; }
        .day-card { background: white; padding: 15px; border-radius: 10px; border-left: 6px solid var(--primary); display: flex; justify-content: space-between; align-items: center; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05); }
        .map-link { color: var(--primary); text-decoration: none; font-size: 0.8rem; font-weight: bold; }
    </style>
</head>
<body>

    <div class="card">
        <h2 style="margin:0 0 15px 0; text-align: center;">‚è±Ô∏è Ponto OCR + GPS</h2>
        
        <button class="btn-main" onclick="document.getElementById('fotoInput').click()">
            üì∏ Tirar Foto do Ponto
        </button>
        <input type="file" id="fotoInput" accept="image/*" capture="environment" style="display:none" onchange="processarPonto(this)">

        <div class="status-box">
            <div id="ocrStatus">‚ö™ Aguardando foto...</div>
            <div id="gpsStatus">‚ö™ Localiza√ß√£o: Verificando...</div>
        </div>

        <div class="grid-inputs">
            <div><label><small>Entrada</small></label><input type="time" id="entrada"></div>
            <div><label><small>Sa√≠da</small></label><input type="time" id="saida"></div>
        </div>

        <img id="preview">
        
        <button onclick="arquivarDia()" class="btn-save">üíæ Arquivar Registro</button>
    </div>

    <div id="historico" class="history-grid"></div>

    <script>
        let base64Image = "";
        let latLog = "";

        // Tentar capturar localiza√ß√£o ao abrir
        function capturarGPS() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(p => {
                    latLog = `${p.coords.latitude},${p.coords.longitude}`;
                    document.getElementById('gpsStatus').innerText = "üìç Localiza√ß√£o capturada!";
                }, () => {
                    document.getElementById('gpsStatus').innerText = "‚ùå GPS n√£o autorizado.";
                });
            }
        }
        capturarGPS();

        async function processarPonto(input) {
            const file = input.files[0];
            if (!file) return;

            // 1. Mostrar Preview
            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onload = async (e) => {
                base64Image = e.target.result;
                const p = document.getElementById('preview');
                p.src = base64Image; p.style.display = 'block';

                // 2. Iniciar OCR
                document.getElementById('ocrStatus').innerText = "üîç Lendo imagem (OCR)...";
                try {
                    const { data: { text } } = await Tesseract.recognize(file, 'eng');
                    console.log("Texto detectado:", text);

                    // Regex para capturar HH:MM
                    const match = text.match(/([01]?[0-9]|2[0-3])[:h][0-5][0-9]/);
                    
                    if (match) {
                        const horaEncontrada = match[0].replace('h', ':');
                        const inputEntrada = document.getElementById('entrada');
                        const inputSaida = document.getElementById('saida');

                        if (!inputEntrada.value) {
                            inputEntrada.value = horaEncontrada;
                        } else {
                            inputSaida.value = horaEncontrada;
                        }
                        document.getElementById('ocrStatus').innerText = `‚úÖ Lido: ${horaEncontrada}`;
                    } else {
                        document.getElementById('ocrStatus').innerText = "‚ö†Ô∏è Hor√°rio n√£o identificado.";
                    }
                } catch (err) {
                    document.getElementById('ocrStatus').innerText = "‚ùå Erro ao ler imagem.";
                }
                capturarGPS(); // Tenta atualizar o GPS no momento da foto
            };
        }

        function arquivarDia() {
            const ent = document.getElementById('entrada').value;
            const sai = document.getElementById('saida').value;
            if (!ent || !sai) return alert("Preencha Entrada e Sa√≠da!");

            const registro = {
                data: new Date().toLocaleDateString('pt-BR'),
                entrada: ent,
                saida: sai,
                gps: latLog,
                foto: base64Image
            };

            let banco = JSON.parse(localStorage.getItem('ponto_db') || '[]');
            banco.push(registro);
            localStorage.setItem('ponto_db', JSON.stringify(banco));
            
            // Limpar campos e recarregar
            location.reload(); 
        }

        function carregarHistorico() {
            const banco = JSON.parse(localStorage.getItem('ponto_db') || '[]');
            const container = document.getElementById('historico');
            
            banco.slice().reverse().forEach(dia => {
                const linkMaps = dia.gps ? `https://www.google.com/maps?q=${dia.gps}` : '#';
                container.innerHTML += `
                    <div class="day-card">
                        <div>
                            <strong>${dia.data}</strong><br>
                            <small>${dia.entrada} ‚ûî ${dia.saida}</small><br>
                            ${dia.gps ? `<a href="${linkMaps}" target="_blank" class="map-link">Ver Localiza√ß√£o</a>` : ''}
                        </div>
                        <img src="${dia.foto}" style="width:50px; height:50px; border-radius:5px; object-fit:cover" onclick="window.open(this.src)">
                    </div>
                `;
            });
        }
        carregarHistorico();
    </script>
</body>
</html>
