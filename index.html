<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ponto Inteligente OCR & GPS</title>
    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@4/dist/tesseract.min.js"></script>
    <style>
        :root { --primary: #2563eb; --success: #16a34a; --danger: #dc2626; --bg: #f8fafc; --text: #1e293b; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); padding: 20px; display: flex; flex-direction: column; align-items: center; color: var(--text); }
        .card { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); width: 100%; max-width: 500px; margin-bottom: 20px; border: 1px solid #e2e8f0; }
        .grid-inputs { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px; }
        input, button { padding: 12px; border-radius: 8px; border: 1px solid #cbd5e1; width: 100%; box-sizing: border-box; font-size: 1rem; }
        button { cursor: pointer; font-weight: bold; transition: 0.2s; border: none; }
        .btn-ocr { background: #7c3aed; color: white; margin-bottom: 15px; width: 100%; position: relative; overflow: hidden; }
        .btn-save { background: var(--text); color: white; margin-top: 15px; width: 100%; }
        .countdown { font-size: 2rem; font-weight: 800; color: var(--primary); text-align: center; margin: 15px 0; }
        .status-gps { font-size: 0.75rem; color: #64748b; margin-top: 5px; text-align: center; }
        #preview { max-width: 100%; border-radius: 8px; margin-top: 10px; display: none; max-height: 150px; }
        .loading-ocr { display: none; font-size: 0.8rem; color: var(--primary); font-weight: bold; margin-bottom: 10px; }
        .history-grid { display: grid; gap: 10px; width: 100%; max-width: 500px; }
        .day-card { background: white; padding: 12px; border-radius: 8px; border-left: 5px solid #cbd5e1; display: flex; justify-content: space-between; align-items: center; }
        .location-link { font-size: 0.7rem; color: var(--primary); text-decoration: none; }
    </style>
</head>
<body>

    <div class="card">
        <h2>‚è±Ô∏è Ponto OCR & GPS</h2>
        
        <button class="btn-ocr" onclick="document.getElementById('fotoInput').click()">
            üì∏ Foto do Comprovante (Auto-Leitura)
        </button>
        <div id="ocrStatus" class="loading-ocr">Lendo hor√°rio da imagem... aguarde...</div>
        
        <input type="file" id="fotoInput" accept="image/*" capture="environment" style="display:none" onchange="processarPontoCompleto(this)">

        <div class="grid-inputs">
            <div><label><small>Entrada</small></label><input type="time" id="entrada"></div>
            <div><label><small>Sa√≠da Final</small></label><input type="time" id="saida"></div>
        </div>

        <div class="countdown" id="timer">00:00:00</div>
        <div id="gpsStatus" class="status-gps">üìç Localiza√ß√£o: N√£o capturada</div>

        <img id="preview">
        
        <button onclick="finalizarDia()" class="btn-save">üíæ Finalizar e Arquivar</button>
    </div>

    <div id="historico" class="history-grid"></div>

    <script>
        let base64Image = "";
        let coordsAtual = "";

        // 1. CAPTURAR LOCALIZA√á√ÉO ASSIM QUE ABRIR OU AO BATER PONTO
        function obterLocalizacao() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(pos => {
                    coordsAtual = `${pos.coords.latitude},${pos.coords.longitude}`;
                    document.getElementById('gpsStatus').innerText = `üìç Localiza√ß√£o capturada!`;
                }, () => {
                    document.getElementById('gpsStatus').innerText = `‚ö†Ô∏è GPS Negado`;
                });
            }
        }
        window.onload = obterLocalizacao;

        // 2. PROCESSAR IMAGEM + OCR (Ler hor√°rio da foto)
        async function processarPontoCompleto(input) {
            const file = input.files[0];
            if (!file) return;

            // Preview da imagem
            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onload = async (e) => {
                base64Image = e.target.result;
                const p = document.getElementById('preview');
                p.src = base64Image; p.style.display = 'block';

                // Iniciar OCR
                document.getElementById('ocrStatus').style.display = 'block';
                try {
                    const result = await Tesseract.recognize(file, 'eng');
                    const texto = result.data.text;
                    
                    // Regex para encontrar hor√°rios (ex: 08:30 ou 08h30)
                    const horarioEncontrado = texto.match(/([01]?[0-9]|2[0-3])[:h][0-5][0-9]/);
                    
                    if (horarioEncontrado) {
                        const horaFormatada = horarioEncontrado[0].replace('h', ':');
                        // Se entrada estiver vazia, preenche entrada, sen√£o preenche sa√≠da
                        if (!document.getElementById('entrada').value) {
                            document.getElementById('entrada').value = horaFormatada;
                        } else {
                            document.getElementById('saida').value = horaFormatada;
                        }
                        alert("Hor√°rio detectado na foto: " + horaFormatada);
                    } else {
                        alert("N√£o consegui ler o hor√°rio automaticamente. Por favor, insira manualmente.");
                    }
                } catch (err) {
                    console.error(err);
                } finally {
                    document.getElementById('ocrStatus').style.display = 'none';
                    obterLocalizacao(); // Garante o GPS no momento da foto
                }
            };
        }

        function finalizarDia() {
            const ent = document.getElementById('entrada').value;
            const sai = document.getElementById('saida').value;
            if (!ent || !sai) return alert("Preencha os hor√°rios!");

            const registro = {
                data: new Date().toLocaleDateString('pt-BR'),
                entrada: ent,
                saida: sai,
                gps: coordsAtual,
                foto: base64Image,
                saldo: ((new Date(`1970-01-01T${sai}:00`) - new Date(`1970-01-01T${ent}:00`)) / 60000) - 540 // jornada 8h + 1h
            };

            let hist = JSON.parse(localStorage.getItem('ponto_db') || '[]');
            hist.push(registro);
            localStorage.setItem('ponto_db', JSON.stringify(hist));
            
            // Limpar rascunho
            location.reload(); 
        }

        function renderizarHistorico() {
            const hist = JSON.parse(localStorage.getItem('ponto_db') || '[]');
            const container = document.getElementById('historico');
            container.innerHTML = '';

            hist.slice().reverse().forEach(dia => {
                const mapLink = dia.gps ? `<a href="https://www.google.com/maps?q=${dia.gps}" target="_blank" class="location-link">üìç Ver Local</a>` : '';
                container.innerHTML += `
                    <div class="day-card">
                        <div>
                            <strong>${dia.data}</strong><br>
                            <small>${dia.entrada} ‚ûî ${dia.saida}</small><br>
                            ${mapLink}
                        </div>
                        <img src="${dia.foto}" style="width:40px;height:40px;border-radius:4px" onclick="window.open(this.src)">
                    </div>`;
            });
        }
        renderizarHistorico();
    </script>
</body>
</html>